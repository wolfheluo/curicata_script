{% extends "base.html" %}

{% block title %}{{ task_name }} - 分析結果{% endblock %}

{% block extra_css %}
<style>
.event-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.event-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.event-card:active {
    transform: translateY(-1px);
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-chart-bar me-2"></i>分析結果</h2>
                <p class="text-muted mb-0">任務：{{ task_name }}</p>
            </div>
            <div>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-1"></i>返回總覽
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 導航標籤 -->
<ul class="nav nav-tabs mb-4" id="analysisTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
            <i class="fas fa-tachometer-alt me-1"></i>總覽
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="flow-tab" data-bs-toggle="tab" data-bs-target="#flow" type="button" role="tab">
            <i class="fas fa-chart-line me-1"></i>流量趨勢
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="topip-tab" data-bs-toggle="tab" data-bs-target="#topip" type="button" role="tab">
            <i class="fas fa-list-ol me-1"></i>Top IP
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="geo-tab" data-bs-toggle="tab" data-bs-target="#geo" type="button" role="tab">
            <i class="fas fa-globe me-1"></i>國別統計
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="events-tab" data-bs-toggle="tab" data-bs-target="#events" type="button" role="tab">
            <i class="fas fa-exclamation-triangle me-1"></i>事件分析
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="anomaly-tab" data-bs-toggle="tab" data-bs-target="#anomaly" type="button" role="tab">
            <i class="fas fa-shield-alt me-1"></i>異常警示
        </button>
    </li>
</ul>

<!-- 標籤內容 -->
<div class="tab-content" id="analysisTabContent">
    <!-- 總覽 -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
        <div class="row" id="overview-cards">
            <!-- 統計卡片將由 JavaScript 動態載入 -->
        </div>
    </div>

    <!-- 流量趨勢 -->
    <div class="tab-pane fade" id="flow" role="tabpanel">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>每10分鐘流量統計</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="flowChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top IP -->
    <div class="tab-pane fade" id="topip" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar me-2"></i>流量排行圖</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="topIpChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list me-2"></i>詳細清單</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="topIpTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>連線</th>
                                        <th>流量</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 資料將由 JavaScript 動態載入 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 國別統計 -->
    <div class="tab-pane fade" id="geo" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie me-2"></i>國別分布圓餅圖</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="geoChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-flag me-2"></i>國別排名</h5>
                    </div>
                    <div class="card-body">
                        <div id="geoList">
                            <!-- 國別清單將由 JavaScript 動態載入 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 事件分析 -->
    <div class="tab-pane fade" id="events" role="tabpanel">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>網路事件統計</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="eventStats">
                            <!-- 事件統計將由 JavaScript 動態載入 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 異常警示 -->
    <div class="tab-pane fade" id="anomaly" role="tabpanel">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-shield-alt me-2"></i>異常行為偵測</h5>
                        <span class="badge bg-danger" id="anomalyCount">0</span>
                    </div>
                    <div class="card-body">
                        <div id="anomalyList">
                            <!-- 異常清單將由 JavaScript 動態載入 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 異常詳情模態視窗 -->
<div class="modal fade" id="anomalyDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title"><i class="fas fa-shield-alt me-2"></i>異常行為詳情</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <!--待補-->

        </div>
    </div>
</div>

<!-- 載入指示器 -->
<div id="loadingIndicator" class="text-center py-5" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">載入中...</span>
    </div>
    <p class="mt-2 text-muted">載入分析資料中...</p>
</div>

<!-- 事件詳細統計模態框 -->
<div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-labelledby="eventDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventDetailsModalLabel">協議詳細統計</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="eventDetailsContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">載入中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const taskName = '{{ task_name }}';
let charts = {};

// 載入所有分析資料
async function loadAllData() {
    document.getElementById('loadingIndicator').style.display = 'block';
    
    try {
        await Promise.all([
            loadOverview(),
            loadFlowData(),
            loadTopIpData(),
            loadGeoData(),
            loadEventData(),
            loadAnomalyData()
        ]);
    } catch (error) {
        console.error('載入資料失敗:', error);
        alert('載入分析資料失敗，請重新整理頁面');
    } finally {
        document.getElementById('loadingIndicator').style.display = 'none';
    }
}

// 載入總覽資料
async function loadOverview() {
    const [flowResponse, eventsResponse, anomalyResponse] = await Promise.all([
        fetch(`/api/flow/${taskName}`),
        fetch(`/api/events/${taskName}`),
        fetch(`/api/anomaly/${taskName}`)
    ]);
    
    const flowData = await flowResponse.json();
    const eventsData = await eventsResponse.json();
    const anomalyData = await anomalyResponse.json();
    
    const totalEvents = Object.values(eventsData).reduce((sum, event) => sum + (event.count || 0), 0);
    
    const overviewCards = document.getElementById('overview-cards');
    overviewCards.innerHTML = `
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <i class="fas fa-database fa-3x text-primary mb-3"></i>
                    <h4>${formatBytes(flowData.total_bytes || 0)}</h4>
                    <p class="text-muted mb-0">總流量</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <i class="fas fa-clock fa-3x text-info mb-3"></i>
                    <h4>${calculateDuration(flowData.start_time, flowData.end_time)}</h4>
                    <p class="text-muted mb-0">分析時長</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h4>${totalEvents.toLocaleString()}</h4>
                    <p class="text-muted mb-0">網路事件</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <i class="fas fa-shield-alt fa-3x text-danger mb-3"></i>
                    <h4>${anomalyData.length}</h4>
                    <p class="text-muted mb-0">異常警示</p>
                </div>
            </div>
        </div>
    `;
}

// 載入流量資料
async function loadFlowData() {
    const response = await fetch(`/api/flow/${taskName}`);
    const data = await response.json();
    
    const ctx = document.getElementById('flowChart').getContext('2d');
    
    if (charts.flow) {
        charts.flow.destroy();
    }
    
    // 使用每10分鐘統計，如果不存在則從每分鐘資料生成
    let flowData = data.per_10_minutes || {};
    
    if (Object.keys(flowData).length === 0 && data.per_minute) {
        // 從每分鐘資料生成每10分鐘統計
        flowData = generateTenMinuteStats(data.per_minute, data.start_time, data.end_time);
    }
    
    // 如果仍然沒有資料，則使用每小時統計
    if (Object.keys(flowData).length === 0 && data.per_hour) {
        flowData = data.per_hour;
    }
    
    // 生成排序後的時間標籤和對應的數據值
    const sortedFlowData = getSortedFlowData(flowData, data.start_time, data.end_time);
    
    charts.flow = new Chart(ctx, {
        type: 'line',
        data: {
            labels: sortedFlowData.labels,
            datasets: [{
                label: '流量 (Bytes)',
                data: sortedFlowData.values,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatBytes(value);
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '流量: ' + formatBytes(context.parsed.y);
                        }
                    }
                }
            }
        }
    });
}

// 載入 Top IP 資料
async function loadTopIpData() {
    const response = await fetch(`/api/top_ip/${taskName}`);
    const data = await response.json();
    
    // 圖表
    const ctx = document.getElementById('topIpChart').getContext('2d');
    
    if (charts.topIp) {
        charts.topIp.destroy();
    }
    
    const top10 = data.slice(0, 10);
    
    charts.topIp = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: top10.map(item => item.connection.substring(0, 20) + '...'),
            datasets: [{
                label: '流量 (Bytes)',
                data: top10.map(item => item.bytes),
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatBytes(value);
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return top10[context[0].dataIndex].connection;
                        },
                        label: function(context) {
                            return '流量: ' + formatBytes(context.parsed.y);
                        }
                    }
                }
            }
        }
    });
    
    // 表格
    const tableBody = document.querySelector('#topIpTable tbody');
    tableBody.innerHTML = data.slice(0, 20).map((item, index) => `
        <tr>
            <td>${index + 1}</td>
            <td><code>${item.connection}</code></td>
            <td>${formatBytes(item.bytes)}</td>
        </tr>
    `).join('');
}

// 載入國別資料
async function loadGeoData() {
    const response = await fetch(`/api/geo/${taskName}`);
    const data = await response.json();
    
    // 將資料轉換為陣列並按計數排序（由多到少）
    const sortedCountries = Object.entries(data)
        .sort((a, b) => b[1] - a[1]);
    
    const countries = sortedCountries.map(([country, count]) => country);
    const counts = sortedCountries.map(([country, count]) => count);
    
    // 圓餅圖
    const ctx = document.getElementById('geoChart').getContext('2d');
    
    if (charts.geo) {
        charts.geo.destroy();
    }
    
    charts.geo = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: countries,
            datasets: [{
                data: counts,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                    '#4BC0C0', '#FF6384'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // 國別清單
    const geoList = document.getElementById('geoList');
    const total = counts.reduce((sum, count) => sum + count, 0);
    
    geoList.innerHTML = sortedCountries.map(([country, count], index) => {
        const percentage = ((count / total) * 100).toFixed(1);
        return `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span><span class="badge bg-secondary me-2">${index + 1}</span><strong>${country}</strong></span>
                <div>
                    <span class="badge bg-primary me-2">${count}</span>
                    <span class="text-muted">${percentage}%</span>
                </div>
            </div>
        `;
    }).join('');
}

// 載入事件資料
async function loadEventData() {
    const response = await fetch(`/api/events/${taskName}`);
    const data = await response.json();
    
    const eventStats = document.getElementById('eventStats');
    eventStats.innerHTML = Object.entries(data).map(([eventType, eventData]) => `
        <div class="col-md-4 col-lg-2 mb-3">
            <div class="card text-center event-card" style="cursor: pointer;" onclick="showEventDetails('${eventType}')">
                <div class="card-body">
                    <i class="fas fa-${getEventIcon(eventType)} fa-2x text-primary mb-2"></i>
                    <h5>${eventData.count || 0}</h5>
                    <p class="card-text">${eventType}</p>
                    <small class="text-muted">主要來源: ${eventData.top_ip || 'N/A'}</small>
                    <div class="mt-2">
                        <small class="badge bg-info">點擊查看詳情</small>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// 載入異常資料
async function loadAnomalyData() {
    const response = await fetch(`/api/anomaly/${taskName}`);
    const data = await response.json();
    
    document.getElementById('anomalyCount').textContent = data.length;
    
    const anomalyList = document.getElementById('anomalyList');
    
    if (data.length === 0) {
        anomalyList.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h5 class="text-success">未發現異常行為</h5>
                <p class="text-muted">所有分析的網路流量都在正常範圍內</p>
            </div>
        `;
    } else {
        // 按異常類型分組
        const groupedData = data.reduce((groups, anomaly) => {
            const type = anomaly.type;
            if (!groups[type]) {
                groups[type] = [];
            }
            groups[type].push(anomaly);
            return groups;
        }, {});

        // 生成分組後的 HTML
        const groupsHtml = Object.entries(groupedData).map(([type, anomalies], index) => {
            const collapseId = `anomaly-collapse-${index}`;
            const severity = getSeverity(type);
            const severityColor = getSeverityColor(type);
            
            return `
                <div class="card mb-3 border-${severityColor}">
                    <div class="card-header bg-${severityColor} bg-opacity-10 border-${severityColor}">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <button class="btn btn-link text-decoration-none p-0 text-${severityColor} fw-bold" 
                                        type="button" 
                                        data-bs-toggle="collapse" 
                                        data-bs-target="#${collapseId}"
                                        aria-expanded="false" 
                                        aria-controls="${collapseId}">
                                    <i class="fas fa-${getAnomalyIcon(type)} me-2"></i>
                                    ${getAnomalyTitle(type)}
                                    <i class="fas fa-chevron-down ms-2 collapse-icon"></i>
                                </button>
                            </h6>
                            <div>
                                <span class="badge bg-${severityColor} me-2">${severity.toUpperCase()}</span>
                                <span class="badge bg-secondary">${anomalies.length} 項</span>
                            </div>
                        </div>
                    </div>
                    <div class="collapse" id="${collapseId}">
                        <div class="card-body">
                            ${anomalies.map((anomaly, anomalyIndex) => `
                                <div class="alert alert-${severityColor} alert-dismissible mb-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <p class="mb-2">${anomaly.description || '偵測到可疑行為'}</p>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <small class="text-muted">
                                                        <i class="fas fa-map-marker-alt me-1"></i>
                                                        <strong>來源 IP:</strong> ${anomaly.ip}
                                                    </small>
                                                </div>
                                                <div class="col-md-6">
                                                    <small class="text-muted">
                                                        <i class="fas fa-clock me-1"></i>
                                                        <strong>時間:</strong> ${new Date(anomaly.time).toLocaleString()}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="ms-3">
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-${severityColor} anomaly-detail-btn" 
                                                    onclick="showAnomalyDetail(${JSON.stringify(anomaly).replace(/"/g, '&quot;')})"
                                                    title="查看詳情">
                                                <i class="fas fa-eye me-1"></i>詳情
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        anomalyList.innerHTML = groupsHtml;

        // 為摺疊按鈕添加圖示切換效果
        document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
            button.addEventListener('click', function() {
                const icon = this.querySelector('.collapse-icon');
                const target = document.querySelector(this.getAttribute('data-bs-target'));
                
                target.addEventListener('shown.bs.collapse', function () {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                });
                
                target.addEventListener('hidden.bs.collapse', function () {
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                });
            });
        });
    }
}

// 工具函數
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function generateTenMinuteStats(perMinuteData, startTime, endTime) {
    const tenMinuteStats = {};
    
    // 找出時間範圍
    const timeKeys = Object.keys(perMinuteData).sort();
    if (timeKeys.length === 0) return {};
    
    // 先累加原始資料到10分鐘區間
    for (const [timeKey, bytes] of Object.entries(perMinuteData)) {
        const [hours, minutes] = timeKey.split(':').map(Number);
        const tenMinuteSlot = Math.floor(minutes / 10) * 10;
        const tenMinuteKey = `${hours.toString().padStart(2, '0')}:${tenMinuteSlot.toString().padStart(2, '0')}`;
        
        if (!tenMinuteStats[tenMinuteKey]) {
            tenMinuteStats[tenMinuteKey] = 0;
        }
        tenMinuteStats[tenMinuteKey] += bytes;
    }
    
    // 如果有開始和結束時間，生成完整的時間序列
    if (startTime && endTime) {
        const start = new Date(startTime);
        const end = new Date(endTime);
        const completeStats = {};
        
        const currentTime = new Date(start);
        currentTime.setMinutes(Math.floor(currentTime.getMinutes() / 10) * 10, 0, 0);
        
        // 按時間順序生成完整序列
        const orderedPairs = [];
        while (currentTime <= end) {
            const timeKey = `${currentTime.getHours().toString().padStart(2, '0')}:${currentTime.getMinutes().toString().padStart(2, '0')}`;
            const value = tenMinuteStats[timeKey] || 0;
            
            orderedPairs.push({
                key: timeKey,
                value: value,
                timestamp: new Date(currentTime)
            });
            
            currentTime.setMinutes(currentTime.getMinutes() + 10);
        }
        
        // 按時間戳排序
        orderedPairs.sort((a, b) => a.timestamp.getTime() - b.timestamp.getTime());
        
        // 重新構建有序的統計對象
        for (const pair of orderedPairs) {
            completeStats[pair.key] = pair.value;
        }
        
        return completeStats;
    }
    
    // 如果沒有時間範圍，返回排序後的統計
    const sortedEntries = Object.entries(tenMinuteStats).sort((a, b) => {
        const [hoursA, minutesA] = a[0].split(':').map(Number);
        const [hoursB, minutesB] = b[0].split(':').map(Number);
        return (hoursA * 60 + minutesA) - (hoursB * 60 + minutesB);
    });
    
    const sortedStats = {};
    for (const [key, value] of sortedEntries) {
        sortedStats[key] = value;
    }
    
    return sortedStats;
}

function generateTimeLabels(flowData, startTime, endTime) {
    const timeKeys = Object.keys(flowData);
    
    // 如果沒有時間信息，直接返回原始鍵值
    if (!startTime || !endTime) {
        return timeKeys;
    }
    
    const start = new Date(startTime);
    const end = new Date(endTime);
    
    // 檢查是否跨天
    const isMultiDay = start.getDate() !== end.getDate() || 
                      start.getMonth() !== end.getMonth() || 
                      start.getFullYear() !== end.getFullYear();
    
    // 如果不跨天，直接返回時間（按時間順序排序）
    if (!isMultiDay) {
        return timeKeys.sort((a, b) => {
            const [hoursA, minutesA] = a.split(':').map(Number);
            const [hoursB, minutesB] = b.split(':').map(Number);
            return (hoursA * 60 + minutesA) - (hoursB * 60 + minutesB);
        });
    }
    
    // 跨天情況：按時間順序生成帶日期的標籤
    const timeValuePairs = [];
    const currentTime = new Date(start);
    currentTime.setMinutes(Math.floor(currentTime.getMinutes() / 10) * 10, 0, 0);
    
    while (currentTime <= end) {
        const timeKey = `${currentTime.getHours().toString().padStart(2, '0')}:${currentTime.getMinutes().toString().padStart(2, '0')}`;
        
        // 檢查這個時間鍵是否存在於數據中
        if (flowData.hasOwnProperty(timeKey)) {
            // 生成帶日期的標籤
            const dateStr = currentTime.toLocaleDateString('zh-TW', { 
                month: '2-digit', 
                day: '2-digit' 
            });
            const timeStr = `${currentTime.getHours().toString().padStart(2, '0')}:${currentTime.getMinutes().toString().padStart(2, '0')}`;
            const label = `${dateStr} ${timeStr}`;
            
            timeValuePairs.push({
                originalKey: timeKey,
                label: label,
                timestamp: new Date(currentTime)
            });
        }
        
        currentTime.setMinutes(currentTime.getMinutes() + 10);
    }
    
    // 按時間戳排序並返回標籤
    timeValuePairs.sort((a, b) => a.timestamp.getTime() - b.timestamp.getTime());
    return timeValuePairs.map(pair => pair.label);
}

function getSortedFlowData(flowData, startTime, endTime) {
    const timeKeys = Object.keys(flowData);
    
    // 如果沒有時間信息，按時間鍵排序
    if (!startTime || !endTime) {
        const sortedEntries = Object.entries(flowData).sort((a, b) => {
            const [hoursA, minutesA] = a[0].split(':').map(Number);
            const [hoursB, minutesB] = b[0].split(':').map(Number);
            return (hoursA * 60 + minutesA) - (hoursB * 60 + minutesB);
        });
        
        return {
            labels: sortedEntries.map(entry => entry[0]),
            values: sortedEntries.map(entry => entry[1])
        };
    }
    
    const start = new Date(startTime);
    const end = new Date(endTime);
    
    // 檢查是否跨天
    const isMultiDay = start.getDate() !== end.getDate() || 
                      start.getMonth() !== end.getMonth() || 
                      start.getFullYear() !== end.getFullYear();
    
    // 如果不跨天，簡單排序
    if (!isMultiDay) {
        const sortedEntries = Object.entries(flowData).sort((a, b) => {
            const [hoursA, minutesA] = a[0].split(':').map(Number);
            const [hoursB, minutesB] = b[0].split(':').map(Number);
            return (hoursA * 60 + minutesA) - (hoursB * 60 + minutesB);
        });
        
        return {
            labels: sortedEntries.map(entry => entry[0]),
            values: sortedEntries.map(entry => entry[1])
        };
    }
    
    // 跨天情況：按時間順序生成帶日期的標籤和對應的數據值
    const sortedPairs = [];
    const currentTime = new Date(start);
    currentTime.setMinutes(Math.floor(currentTime.getMinutes() / 10) * 10, 0, 0);
    
    while (currentTime <= end) {
        const timeKey = `${currentTime.getHours().toString().padStart(2, '0')}:${currentTime.getMinutes().toString().padStart(2, '0')}`;
        
        // 檢查這個時間鍵是否存在於數據中
        if (flowData.hasOwnProperty(timeKey)) {
            // 生成帶日期的標籤
            const dateStr = currentTime.toLocaleDateString('zh-TW', { 
                month: '2-digit', 
                day: '2-digit' 
            });
            const timeStr = `${currentTime.getHours().toString().padStart(2, '0')}:${currentTime.getMinutes().toString().padStart(2, '0')}`;
            const label = `${dateStr} ${timeStr}`;
            
            sortedPairs.push({
                label: label,
                value: flowData[timeKey],
                timestamp: new Date(currentTime)
            });
        }
        
        currentTime.setMinutes(currentTime.getMinutes() + 10);
    }
    
    // 按時間戳排序
    sortedPairs.sort((a, b) => a.timestamp.getTime() - b.timestamp.getTime());
    
    return {
        labels: sortedPairs.map(pair => pair.label),
        values: sortedPairs.map(pair => pair.value)
    };
}

function calculateDuration(startTime, endTime) {
    if (!startTime || !endTime) return 'N/A';
    const start = new Date(startTime);
    const end = new Date(endTime);
    const diffMs = end - start;
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
    return `${diffHours}h ${diffMinutes}m`;
}

function getEventIcon(eventType) {
    const icons = {
        // 待補
    };
    return icons[eventType] || 'question';
}

function getAnomalyIcon(type) {
    const icons = {
        // 待補
    };
    return icons[type] || 'exclamation-circle';
}

// 顯示事件詳細統計
async function showEventDetails(protocol) {
    const modal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
    const modalTitle = document.getElementById('eventDetailsModalLabel');
    const modalContent = document.getElementById('eventDetailsContent');
    
    modalTitle.textContent = `${protocol} 協議詳細統計`;
    modalContent.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">載入中...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    try {
        const response = await fetch(`/api/event_details/${taskName}/${protocol}`);
        const data = await response.json();
        
        if (data.error) {
            modalContent.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${data.error}
                </div>
            `;
            return;
        }
        
        const topConnections = data.top_connections || [];
        
        modalContent.innerHTML = `
            <div class="mb-3">
                <h6><i class="fas fa-info-circle me-2"></i>總覽</h6>
                <p class="mb-1"><strong>協議：</strong>${data.protocol}</p>
                <p class="mb-1"><strong>總封包數：</strong>${data.total_count?.toLocaleString() || 0}</p>
            </div>
            
            <h6><i class="fas fa-trophy me-2"></i>前5名連接統計</h6>
            ${topConnections.length === 0 ? 
                '<div class="alert alert-info">尚無詳細統計資料</div>' :
                `<div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>來源 IP</th>
                                <th>目標 IP</th>
                                <th>封包數</th>
                                <th>封包大小 (Bytes)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${topConnections.map((conn, index) => `
                                <tr>
                                    <td>
                                        <span class="badge ${index < 3 ? 'bg-warning' : 'bg-secondary'}">
                                            ${index + 1}
                                        </span>
                                    </td>
                                    <td>
                                        <code>${conn.src_ip}</code>
                                    </td>
                                    <td>
                                        <code>${conn.dst_ip}</code>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">${conn.packet_count?.toLocaleString() || 0}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">${formatBytes(conn.packet_size || 0)}</span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`
            }
        `;
        
    } catch (error) {
        modalContent.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                載入失敗：${error.message}
            </div>
        `;
    }
}

// 格式化字節大小
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function getAnomalyTitle(type) {
    const titles = {
        // 待補
    };
    return titles[type] || type;
}

function getSeverity(type) {
    const severities = {
        // 待補
    };
    return severities[type] || 'low';
}

function getSeverityColor(type) {
    const severity = getSeverity(type);
    const colors = {
        'high': 'danger',
        'medium': 'warning',
        'low': 'info'
    };
    return colors[severity] || 'secondary';
}



// HTML 轉義函數
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

document.addEventListener('DOMContentLoaded', function() {
    loadAllData();
});
</script>
{% endblock %}
