{% extends "base.html" %}

{% block title %}{{ task_name }} - åˆ†æçµæœ{% endblock %}

{% block extra_css %}
<style>
.event-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    min-height: 200px; /* çµ±ä¸€ card é«˜åº¦ */
}

.event-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.event-card:active {
    transform: translateY(-1px);
}

.event-card .card-body {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 1rem;
}

.event-card .card-text {
    font-weight: 500;
    font-size: 0.9rem;
}

/* ç¢ºä¿æ‰€æœ‰äº‹ä»¶å¡ç‰‡æœ‰ç›¸åŒé«˜åº¦ */
.event-card.h-100 {
    height: 100% !important;
}

/* TOP IP è©³æƒ…å€åŸŸæ¨£å¼ */
#topIpDetailsSection .text-truncate {
    max-width: 150px;
}

/* éŸ¿æ‡‰å¼èª¿æ•´ */
@media (max-width: 768px) {
    .event-card {
        min-height: 160px;
    }
    
    #topIpDetailsSection .text-truncate {
        max-width: 120px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-chart-bar me-2"></i>åˆ†æçµæœ</h2>
                <p class="text-muted mb-0">ä»»å‹™ï¼š{{ task_name }}</p>
            </div>
            <div>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-1"></i>è¿”å›ç¸½è¦½
                </a>
            </div>
        </div>
    </div>
</div>

<!-- å°èˆªæ¨™ç±¤ -->
<ul class="nav nav-tabs mb-4" id="analysisTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
            <i class="fas fa-tachometer-alt me-1"></i>ç¸½è¦½
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="flow-tab" data-bs-toggle="tab" data-bs-target="#flow" type="button" role="tab">
            <i class="fas fa-chart-line me-1"></i>æµé‡è¶¨å‹¢
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="topip-tab" data-bs-toggle="tab" data-bs-target="#topip" type="button" role="tab">
            <i class="fas fa-list-ol me-1"></i>Top IP
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="geo-tab" data-bs-toggle="tab" data-bs-target="#geo" type="button" role="tab">
            <i class="fas fa-globe me-1"></i>åœ‹åˆ¥çµ±è¨ˆ
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="events-tab" data-bs-toggle="tab" data-bs-target="#events" type="button" role="tab">
            <i class="fas fa-exclamation-triangle me-1"></i>äº‹ä»¶åˆ†æ
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="anomaly-tab" data-bs-toggle="tab" data-bs-target="#anomaly" type="button" role="tab">
            <i class="fas fa-shield-alt me-1"></i>ç•°å¸¸è­¦ç¤º
        </button>
    </li>
</ul>

<!-- æ¨™ç±¤å…§å®¹ -->
<div class="tab-content" id="analysisTabContent">
    <!-- ç¸½è¦½ -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
        <div class="row" id="overview-cards">
            <!-- çµ±è¨ˆå¡ç‰‡å°‡ç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
        </div>
    </div>

    <!-- æµé‡è¶¨å‹¢ -->
    <div class="tab-pane fade" id="flow" role="tabpanel">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>æ¯10åˆ†é˜æµé‡çµ±è¨ˆ</h5>
                        <small class="text-muted">é»æ“Šåœ–è¡¨ä¸Šçš„æ•¸æ“šé»ä»¥æŸ¥çœ‹è©²æ™‚é–“æ®µçš„å‰5å¤§æµé‡æ’è¡Œ</small>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="flowChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 10åˆ†é˜è©³ç´°çµ±è¨ˆå±•é–‹å€åŸŸ -->
        <div class="row mt-3" id="flowDetailsSection" style="display: none;">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info bg-opacity-10">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-clock me-2 text-info"></i>
                                <span id="selectedTimeLabel">é¸å®šæ™‚é–“æ®µè©³ç´°çµ±è¨ˆ</span>
                            </h6>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="hideFlowDetails()">
                                <i class="fas fa-times me-1"></i>é—œé–‰
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <i class="fas fa-database fa-2x text-primary mb-2"></i>
                                        <h5 id="selectedTimeTotalBytes">-</h5>
                                        <p class="text-muted mb-0">è©²æ™‚æ®µç¸½æµé‡</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <i class="fas fa-crown fa-2x text-warning mb-2"></i>
                                        <h5 id="selectedTimeConnectionCount">-</h5>
                                        <p class="text-muted mb-0">å‰5å¤§é€£æ¥</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h6><i class="fas fa-trophy me-2"></i>å‰5å¤§æµé‡æ’è¡Œ</h6>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th width="80">æ’å</th>
                                        <th>é€£æ¥</th>
                                        <th width="120">æµé‡</th>
                                        <th width="100">ä½”æ¯”</th>
                                    </tr>
                                </thead>
                                <tbody id="selectedTimeTopConnections">
                                    <!-- è©³ç´°é€£æ¥æ•¸æ“šå°‡ç”± JavaScript å¡«å…… -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top IP -->
    <div class="tab-pane fade" id="topip" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar me-2"></i>æµé‡æ’è¡Œåœ–</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="topIpChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list me-2"></i>è©³ç´°æ¸…å–®</h5>
                        <small class="text-muted">é»æ“Šä»»ä¸€é …ç›®æŸ¥çœ‹é«˜æµé‡æ™‚é–“æ®µ</small>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="topIpTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>é€£ç·š</th>
                                        <th>æµé‡</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- è³‡æ–™å°‡ç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TOP IP é«˜æµé‡æ™‚é–“æ®µè©³ç´°è³‡è¨Šå±•é–‹å€åŸŸ -->
        <div class="row mt-3" id="topIpDetailsSection" style="display: none;">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary bg-opacity-10">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-chart-line me-2 text-primary"></i>
                                <span id="selectedConnectionLabel">é€£ç·šé«˜æµé‡æ™‚é–“æ®µåˆ†æ</span>
                            </h6>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="hideTopIpDetails()">
                                <i class="fas fa-times me-1"></i>é—œé–‰
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <i class="fas fa-server fa-2x text-primary mb-2"></i>
                                        <h6 id="selectedConnectionName" class="text-truncate">-</h6>
                                        <p class="text-muted mb-0 small">é¸å®šé€£ç·š</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <i class="fas fa-network-wired fa-2x text-info mb-2"></i>
                                        <h6 id="selectedConnectionProtocol">-</h6>
                                        <p class="text-muted mb-0 small">å”è­°é¡å‹</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <i class="fas fa-database fa-2x text-success mb-2"></i>
                                        <h6 id="selectedConnectionTotalBytes">-</h6>
                                        <p class="text-muted mb-0 small">ç¸½æµé‡</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                                        <h6 id="selectedConnectionPeriodCount">-</h6>
                                        <p class="text-muted mb-0 small">é«˜æµé‡æ™‚æ®µ</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h6><i class="fas fa-trophy me-2"></i>å‰ä¸‰å¤§æµé‡æ™‚é–“æ®µ</h6>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th width="80">æ’å</th>
                                        <th>æ™‚é–“æ®µ</th>
                                        <th width="120">æµé‡</th>
                                        <th width="100">ä½”æ¯”</th>
                                        <th width="120">æµé‡å¯†åº¦</th>
                                    </tr>
                                </thead>
                                <tbody id="selectedConnectionTimePeriods">
                                    <!-- è©³ç´°æ™‚é–“æ®µæ•¸æ“šå°‡ç”± JavaScript å¡«å…… -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>èªªæ˜ï¼š</strong>æ­¤è¡¨é¡¯ç¤ºè©²é€£ç·šåœ¨ä¸åŒ10åˆ†é˜æ™‚é–“æ®µå…§ç”¢ç”Ÿçš„æµé‡çµ±è¨ˆï¼Œå¯å¹«åŠ©è­˜åˆ¥æµé‡é«˜å³°æœŸå’Œç•°å¸¸æ´»å‹•æ¨¡å¼ã€‚
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åœ‹åˆ¥çµ±è¨ˆ -->
    <div class="tab-pane fade" id="geo" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie me-2"></i>åœ‹åˆ¥åˆ†å¸ƒåœ“é¤…åœ–</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="geoChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-flag me-2"></i>åœ‹åˆ¥æ’å</h5>
                    </div>
                    <div class="card-body">
                        <div id="geoList">
                            <!-- åœ‹åˆ¥æ¸…å–®å°‡ç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- äº‹ä»¶åˆ†æ -->
    <div class="tab-pane fade" id="events" role="tabpanel">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>ç¶²è·¯äº‹ä»¶çµ±è¨ˆ</h5>
                        <small class="text-muted">é»æ“Šä»»ä¸€å”è­°å¡ç‰‡æŸ¥çœ‹è©³ç´°çµ±è¨ˆ</small>
                    </div>
                    <div class="card-body">
                        <div class="row" id="eventStats">
                            <!-- äº‹ä»¶çµ±è¨ˆå°‡ç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç•°å¸¸è­¦ç¤º -->
    <div class="tab-pane fade" id="anomaly" role="tabpanel">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-shield-alt me-2"></i>ç•°å¸¸è¡Œç‚ºåµæ¸¬</h5>
                        <span class="badge bg-danger" id="anomalyCount">0</span>
                    </div>
                    <div class="card-body">
                        <div id="anomalyList">
                            <!-- ç•°å¸¸æ¸…å–®å°‡ç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
<div id="loadingIndicator" class="text-center py-5" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
    </div>
    <p class="mt-2 text-muted">è¼‰å…¥åˆ†æè³‡æ–™ä¸­...</p>
</div>

<!-- äº‹ä»¶è©³ç´°çµ±è¨ˆæ¨¡æ…‹æ¡† -->
<div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-labelledby="eventDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventDetailsModalLabel">å”è­°è©³ç´°çµ±è¨ˆ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="eventDetailsContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const taskName = '{{ task_name }}';
let charts = {};

// è¼‰å…¥æ‰€æœ‰åˆ†æè³‡æ–™
async function loadAllData() {
    document.getElementById('loadingIndicator').style.display = 'block';
    
    try {
        await Promise.all([
            loadOverview(),
            loadFlowData(),
            loadTopIpData(),
            loadGeoData(),
            loadEventData(),
            loadAnomalyData()
        ]);
    } catch (error) {
        console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
        alert('è¼‰å…¥åˆ†æè³‡æ–™å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
    } finally {
        document.getElementById('loadingIndicator').style.display = 'none';
    }
}

// è¼‰å…¥ç¸½è¦½è³‡æ–™
async function loadOverview() {
    const [flowResponse, eventsResponse, anomalyResponse] = await Promise.all([
        fetch(`/api/flow/${taskName}`),
        fetch(`/api/events/${taskName}`),
        fetch(`/api/anomaly/${taskName}`)
    ]);
    
    const flowData = await flowResponse.json();
    const eventsData = await eventsResponse.json();
    const anomalyData = await anomalyResponse.json();
    
    const totalEvents = Object.values(eventsData).reduce((sum, event) => sum + (event.count || 0), 0);
    
    const overviewCards = document.getElementById('overview-cards');
    overviewCards.innerHTML = `
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <i class="fas fa-database fa-3x text-primary mb-3"></i>
                    <h4>${formatBytes(flowData.total_bytes || 0)}</h4>
                    <p class="text-muted mb-0">ç¸½æµé‡</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <i class="fas fa-clock fa-3x text-info mb-3"></i>
                    <h4>${calculateDuration(flowData.start_time, flowData.end_time)}</h4>
                    <p class="text-muted mb-0">åˆ†ææ™‚é•·</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h4>${totalEvents.toLocaleString()}</h4>
                    <p class="text-muted mb-0">ç¶²è·¯äº‹ä»¶</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <i class="fas fa-shield-alt fa-3x text-danger mb-3"></i>
                    <h4>${anomalyData.length}</h4>
                    <p class="text-muted mb-0">ç•°å¸¸è­¦ç¤º</p>
                </div>
            </div>
        </div>
    `;
}

// è¼‰å…¥æµé‡è³‡æ–™
async function loadFlowData() {
    const response = await fetch(`/api/flow/${taskName}`);
    const data = await response.json();
    
    const ctx = document.getElementById('flowChart').getContext('2d');
    
    if (charts.flow) {
        charts.flow.destroy();
    }
    
    // ä½¿ç”¨æ¯10åˆ†é˜çµ±è¨ˆï¼Œå¦‚æœä¸å­˜åœ¨å‰‡å¾æ¯åˆ†é˜è³‡æ–™ç”Ÿæˆ
    let flowData = data.per_10_minutes || {};
    
    if (Object.keys(flowData).length === 0 && data.per_minute) {
        // å¾æ¯åˆ†é˜è³‡æ–™ç”Ÿæˆæ¯10åˆ†é˜çµ±è¨ˆ
        flowData = generateTenMinuteStats(data.per_minute, data.start_time, data.end_time);
    }
    
    // å¦‚æœä»ç„¶æ²’æœ‰è³‡æ–™ï¼Œå‰‡ä½¿ç”¨æ¯å°æ™‚çµ±è¨ˆ
    if (Object.keys(flowData).length === 0 && data.per_hour) {
        flowData = data.per_hour;
    }
    
    // ç”Ÿæˆæ’åºå¾Œçš„æ™‚é–“æ¨™ç±¤å’Œå°æ‡‰çš„æ•¸æ“šå€¼
    const sortedFlowData = getSortedFlowData(flowData, data.start_time, data.end_time);
    
    // å„²å­˜æ™‚é–“å°æ‡‰é—œä¿‚ï¼Œä¾›é»æ“Šäº‹ä»¶ä½¿ç”¨
    window.flowTimeMapping = Object.keys(flowData).sort();
    window.hasTopIpDetails = data.top_ip_per_10_minutes && Object.keys(data.top_ip_per_10_minutes).length > 0;
    
    charts.flow = new Chart(ctx, {
        type: 'line',
        data: {
            labels: sortedFlowData.labels,
            datasets: [{
                label: 'æµé‡ (Bytes)',
                data: sortedFlowData.values,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 6,
                pointHoverRadius: 8,
                pointBackgroundColor: 'rgb(75, 192, 192)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'point'
            },
            onHover: (event, activeElements) => {
                event.native.target.style.cursor = activeElements.length > 0 && window.hasTopIpDetails ? 'pointer' : 'default';
            },
            onClick: (event, activeElements) => {
                if (activeElements.length > 0 && window.hasTopIpDetails) {
                    const dataIndex = activeElements[0].index;
                    const timeKey = window.flowTimeMapping[dataIndex];
                    showFlowDetails(timeKey);
                }
            },
            scales: {
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatBytes(value);
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const timeKey = window.flowTimeMapping[context.dataIndex];
                            let tooltipText = 'æµé‡: ' + formatBytes(context.parsed.y);
                            if (window.hasTopIpDetails) {
                                tooltipText += '\né»æ“ŠæŸ¥çœ‹å‰5å¤§æµé‡æ’è¡Œ';
                            }
                            return tooltipText;
                        }
                    }
                },
                legend: {
                    display: true,
                    labels: {
                        generateLabels: function(chart) {
                            const original = Chart.defaults.plugins.legend.labels.generateLabels;
                            const labels = original.call(this, chart);
                            
                            if (window.hasTopIpDetails) {
                                labels.push({
                                    text: 'ğŸ’¡ é»æ“Šæ•¸æ“šé»æŸ¥çœ‹è©³ç´°æ’è¡Œ',
                                    fontColor: '#666',
                                    fillStyle: 'transparent',
                                    strokeStyle: 'transparent',
                                    pointStyle: 'line'
                                });
                            }
                            
                            return labels;
                        }
                    }
                }
            }
        }
    });
}

// è¼‰å…¥ Top IP è³‡æ–™
async function loadTopIpData() {
    const response = await fetch(`/api/top_ip/${taskName}`);
    const data = await response.json();
    
    // å„²å­˜ top IP è³‡æ–™ä¾›è©³ç´°å±•ç¤ºä½¿ç”¨
    window.topIpData = data;
    
    // åœ–è¡¨
    const ctx = document.getElementById('topIpChart').getContext('2d');
    
    if (charts.topIp) {
        charts.topIp.destroy();
    }
    
    const top10 = data.slice(0, 10);
    
    charts.topIp = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: top10.map(item => item.connection.substring(0, 20) + '...'),
            datasets: [{
                label: 'æµé‡ (Bytes)',
                data: top10.map(item => item.bytes),
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatBytes(value);
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return top10[context[0].dataIndex].connection;
                        },
                        label: function(context) {
                            return 'æµé‡: ' + formatBytes(context.parsed.y);
                        }
                    }
                }
            }
        }
    });
    
    // è¡¨æ ¼
    const tableBody = document.querySelector('#topIpTable tbody');
    tableBody.innerHTML = data.slice(0, 20).map((item, index) => {
        return `
        <tr>
            <td>${index + 1}</td>
            <td><code class="text-break">${item.connection}</code></td>
            <td>${formatBytes(item.bytes)}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="showTopIpDetails(${index})" title="æŸ¥çœ‹é«˜æµé‡æ™‚é–“æ®µ">
                    <i class="fas fa-chart-line me-1"></i>æ™‚é–“æ®µ
                </button>
            </td>
        </tr>
        `;
    }).join('');
}

// è¼‰å…¥åœ‹åˆ¥è³‡æ–™
async function loadGeoData() {
    const response = await fetch(`/api/geo/${taskName}`);
    const data = await response.json();
    
    // å°‡è³‡æ–™è½‰æ›ç‚ºé™£åˆ—ä¸¦æŒ‰è¨ˆæ•¸æ’åºï¼ˆç”±å¤šåˆ°å°‘ï¼‰
    const sortedCountries = Object.entries(data)
        .sort((a, b) => b[1] - a[1]);
    
    // åªå–å‰10åï¼Œå…¶é¤˜æ­¸é¡ç‚º"å…¶ä»–"
    const top10Countries = sortedCountries.slice(0, 10);
    const othersData = sortedCountries.slice(10);
    
    // è¨ˆç®—"å…¶ä»–"çš„ç¸½æ•¸
    const othersTotal = othersData.reduce((sum, [country, count]) => sum + count, 0);
    
    // æº–å‚™åœ–è¡¨æ•¸æ“š
    let chartCountries = top10Countries.map(([country, count]) => country);
    let chartCounts = top10Countries.map(([country, count]) => count);
    
    // å¦‚æœæœ‰å…¶ä»–åœ‹å®¶ï¼Œæ·»åŠ åˆ°æ•¸æ“šä¸­
    if (othersTotal > 0) {
        chartCountries.push('å…¶ä»–');
        chartCounts.push(othersTotal);
    }
    
    // åœ“é¤…åœ–
    const ctx = document.getElementById('geoChart').getContext('2d');
    
    if (charts.geo) {
        charts.geo.destroy();
    }
    
    charts.geo = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: chartCountries,
            datasets: [{
                data: chartCounts,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#FF8C69', '#20B2AA',
                    '#9370DB', '#32CD32', '#D3D3D3'  // æœ€å¾Œä¸€å€‹ç°è‰²ä»£è¡¨"å…¶ä»–"
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            
                            if (label === 'å…¶ä»–') {
                                return `å…¶ä»– (${othersData.length}å€‹åœ‹å®¶): ${value.toLocaleString()} (${percentage}%)`;
                            }
                            return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    // åœ‹åˆ¥æ¸…å–®
    const geoList = document.getElementById('geoList');
    const total = chartCounts.reduce((sum, count) => sum + count, 0);
    
    // ç”Ÿæˆå‰10åçš„æ¸…å–®
    let listHtml = top10Countries.map(([country, count], index) => {
        const percentage = ((count / total) * 100).toFixed(1);
        return `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span><span class="badge bg-secondary me-2">${index + 1}</span><strong>${country}</strong></span>
                <div>
                    <span class="badge bg-primary me-2">${count.toLocaleString()}</span>
                    <span class="text-muted">${percentage}%</span>
                </div>
            </div>
        `;
    });
    
    // å¦‚æœæœ‰å…¶ä»–åœ‹å®¶ï¼Œæ·»åŠ "å…¶ä»–"é …ç›®
    if (othersTotal > 0) {
        const othersPercentage = ((othersTotal / total) * 100).toFixed(1);
        listHtml.push(`
            <div class="d-flex justify-content-between align-items-center mb-2 border-top pt-2">
                <span>
                    <span class="badge bg-light text-dark me-2">å…¶ä»–</span>
                    <strong>å…¶ä»– (${othersData.length}å€‹åœ‹å®¶)</strong>
                </span>
                <div>
                    <span class="badge bg-secondary me-2">${othersTotal.toLocaleString()}</span>
                    <span class="text-muted">${othersPercentage}%</span>
                </div>
            </div>
        `);
        
        // æ·»åŠ å¯å±•é–‹çš„å…¶ä»–åœ‹å®¶è©³ç´°æ¸…å–®
        if (othersData.length > 0) {
            listHtml.push(`
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-secondary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#otherCountriesCollapse" aria-expanded="false">
                        <i class="fas fa-eye me-1"></i>æŸ¥çœ‹å…¶ä»–åœ‹å®¶è©³æƒ…
                        <i class="fas fa-chevron-down ms-1"></i>
                    </button>
                    <div class="collapse mt-2" id="otherCountriesCollapse">
                        <div class="card card-body bg-light">
                            <h6 class="mb-2"><i class="fas fa-list me-1"></i>å…¶ä»–åœ‹å®¶æ¸…å–®ï¼š</h6>
                            ${othersData.map(([country, count], index) => {
                                const percentage = ((count / total) * 100).toFixed(1);
                                return `
                                    <div class="d-flex justify-content-between align-items-center mb-1 small">
                                        <span><span class="badge bg-light text-dark me-1">${index + 11}</span>${country}</span>
                                        <div>
                                            <span class="badge bg-outline-primary me-1">${count.toLocaleString()}</span>
                                            <span class="text-muted">${percentage}%</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `);
        }
    }
    
    geoList.innerHTML = listHtml.join('');
}

// è¼‰å…¥äº‹ä»¶è³‡æ–™
async function loadEventData() {
    const response = await fetch(`/api/events/${taskName}`);
    const data = await response.json();
    
    const eventStats = document.getElementById('eventStats');
    eventStats.innerHTML = Object.entries(data).map(([eventType, eventData]) => `
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
            <div class="card text-center event-card h-100" style="cursor: pointer;" onclick="showEventDetails('${eventType}')">
                <div class="card-body d-flex flex-column">
                    <i class="fas fa-${getEventIcon(eventType)} fa-2x text-primary mb-2"></i>
                    <h5 class="mb-2">${eventData.count || 0}</h5>
                    <p class="card-text mb-2 flex-grow-1">${eventType}</p>
                    <small class="text-muted mb-2">ä¸»è¦ä¾†æº: ${eventData.top_ip || 'N/A'}</small>
                    <div class="mt-auto">
                        <small class="badge bg-info">é»æ“ŠæŸ¥çœ‹è©³æƒ…</small>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// è¼‰å…¥ç•°å¸¸è³‡æ–™
async function loadAnomalyData() {
    const response = await fetch(`/api/anomaly/${taskName}`);
    const data = await response.json();
    
    document.getElementById('anomalyCount').textContent = data.length;
    
    const anomalyList = document.getElementById('anomalyList');
    
    if (data.length === 0) {
        anomalyList.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h5 class="text-success">æœªç™¼ç¾ç•°å¸¸è¡Œç‚º</h5>
                <p class="text-muted">æ‰€æœ‰åˆ†æçš„ç¶²è·¯æµé‡éƒ½åœ¨æ­£å¸¸ç¯„åœå…§</p>
            </div>
        `;
    } else {
        // æŒ‰ç•°å¸¸é¡å‹åˆ†çµ„
        const groupedData = data.reduce((groups, anomaly) => {
            const type = anomaly.type;
            if (!groups[type]) {
                groups[type] = [];
            }
            groups[type].push(anomaly);
            return groups;
        }, {});

        // ç”Ÿæˆåˆ†çµ„å¾Œçš„ HTML
        const groupsHtml = Object.entries(groupedData).map(([type, anomalies], index) => {
            const collapseId = `anomaly-collapse-${index}`;
            const severity = getSeverity(type);
            const severityColor = getSeverityColor(type);
            
            return `
                <div class="card mb-3 border-${severityColor}">
                    <div class="card-header bg-${severityColor} bg-opacity-10 border-${severityColor}">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <button class="btn btn-link text-decoration-none p-0 text-${severityColor} fw-bold" 
                                        type="button" 
                                        data-bs-toggle="collapse" 
                                        data-bs-target="#${collapseId}"
                                        aria-expanded="false" 
                                        aria-controls="${collapseId}">
                                    <i class="fas fa-${getAnomalyIcon(type)} me-2"></i>
                                    ${getAnomalyTitle(type)}
                                    <i class="fas fa-chevron-down ms-2 collapse-icon"></i>
                                </button>
                            </h6>
                            <div>
                                <span class="badge bg-${severityColor} me-2">${severity.toUpperCase()}</span>
                                <span class="badge bg-secondary">${anomalies.length} é …</span>
                            </div>
                        </div>
                    </div>
                    <div class="collapse" id="${collapseId}">
                        <div class="card-body">
                            ${anomalies.map((anomaly, anomalyIndex) => `
                                <div class="alert alert-${severityColor} alert-dismissible mb-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <p class="mb-2">${anomaly.description || 'åµæ¸¬åˆ°å¯ç–‘è¡Œç‚º'}</p>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <small class="text-muted">
                                                        <i class="fas fa-map-marker-alt me-1"></i>
                                                        <strong>ä¾†æº IP:</strong> ${anomaly.ip}
                                                    </small>
                                                </div>
                                                <div class="col-md-6">
                                                    <small class="text-muted">
                                                        <i class="fas fa-clock me-1"></i>
                                                        <strong>æ™‚é–“:</strong> ${new Date(anomaly.time).toLocaleString()}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="ms-3">
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-${severityColor} anomaly-detail-btn" 
                                                    onclick="showAnomalyDetail(${JSON.stringify(anomaly).replace(/"/g, '&quot;')})"
                                                    title="æŸ¥çœ‹è©³æƒ…">
                                                <i class="fas fa-eye me-1"></i>è©³æƒ…
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        anomalyList.innerHTML = groupsHtml;

        // ç‚ºæ‘ºç–ŠæŒ‰éˆ•æ·»åŠ åœ–ç¤ºåˆ‡æ›æ•ˆæœ
        document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
            button.addEventListener('click', function() {
                const icon = this.querySelector('.collapse-icon');
                const target = document.querySelector(this.getAttribute('data-bs-target'));
                
                target.addEventListener('shown.bs.collapse', function () {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                });
                
                target.addEventListener('hidden.bs.collapse', function () {
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                });
            });
        });
    }
}

// å·¥å…·å‡½æ•¸
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}


function calculateDuration(startTime, endTime) {
    if (!startTime || !endTime) return 'N/A';
    const start = new Date(startTime);
    const end = new Date(endTime);
    const diffMs = end - start;
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
    return `${diffHours}h ${diffMinutes}m`;
}

function getEventIcon(eventType) {
    const icons = {
    };
    return icons[eventType] || 'question';
}

function getAnomalyIcon(type) {
    const icons = {
    };
    return icons[type] || 'exclamation-circle';
}

// é¡¯ç¤ºäº‹ä»¶è©³ç´°çµ±è¨ˆ
async function showEventDetails(protocol) {
    const modal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
    const modalTitle = document.getElementById('eventDetailsModalLabel');
    const modalContent = document.getElementById('eventDetailsContent');
    
    modalTitle.textContent = `${protocol} å”è­°è©³ç´°çµ±è¨ˆ`;
    modalContent.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    try {
        const response = await fetch(`/api/event_details/${taskName}/${protocol}`);
        const data = await response.json();
        
        if (data.error) {
            modalContent.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${data.error}
                </div>
            `;
            return;
        }
        
        const topConnections = data.top_connections || [];
        
        modalContent.innerHTML = `
            <div class="mb-3">
                <h6><i class="fas fa-info-circle me-2"></i>ç¸½è¦½</h6>
                <p class="mb-1"><strong>å”è­°ï¼š</strong>${data.protocol}</p>
                <p class="mb-1"><strong>ç¸½å°åŒ…æ•¸ï¼š</strong>${data.total_count?.toLocaleString() || 0}</p>
            </div>
            
            <h6><i class="fas fa-trophy me-2"></i>å‰5åé€£æ¥çµ±è¨ˆ</h6>
            ${topConnections.length === 0 ? 
                '<div class="alert alert-info">å°šç„¡è©³ç´°çµ±è¨ˆè³‡æ–™</div>' :
                `<div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>ä¾†æº IP</th>
                                <th>ç›®æ¨™ IP</th>
                                <th>å°åŒ…æ•¸</th>
                                <th>å°åŒ…å¤§å° (Bytes)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${topConnections.map((conn, index) => `
                                <tr>
                                    <td>
                                        <span class="badge ${index < 3 ? 'bg-warning' : 'bg-secondary'}">
                                            ${index + 1}
                                        </span>
                                    </td>
                                    <td>
                                        <code>${conn.src_ip}</code>
                                    </td>
                                    <td>
                                        <code>${conn.dst_ip}</code>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">${conn.packet_count?.toLocaleString() || 0}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">${formatBytes(conn.packet_size || 0)}</span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`
            }
        `;
        
    } catch (error) {
        modalContent.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                è¼‰å…¥å¤±æ•—ï¼š${error.message}
            </div>
        `;
    }
}

// æ ¼å¼åŒ–å­—ç¯€å¤§å°
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// å¾æ¯åˆ†é˜è³‡æ–™ç”Ÿæˆæ¯10åˆ†é˜çµ±è¨ˆ
function generateTenMinuteStats(perMinuteData, startTime, endTime) {
    const result = {};
    
    for (const [timeStr, bytesVal] of Object.entries(perMinuteData)) {
        try {
            const timeObj = new Date(timeStr);
            const minuteBoundary = Math.floor(timeObj.getMinutes() / 10) * 10;
            const boundaryTime = new Date(timeObj);
            boundaryTime.setMinutes(minuteBoundary, 0, 0);
            
            const boundaryStr = boundaryTime.toISOString().slice(0, 16).replace('T', ' ');
            
            if (!result[boundaryStr]) {
                result[boundaryStr] = 0;
            }
            result[boundaryStr] += bytesVal;
        } catch (e) {
            continue;
        }
    }
    
    return result;
}

// ç”Ÿæˆæ’åºå¾Œçš„æµé‡è³‡æ–™
function getSortedFlowData(flowData, startTime, endTime) {
    const sortedItems = Object.entries(flowData).sort();
    const labels = [];
    const values = [];
    
    for (const [timeStr, bytesVal] of sortedItems) {
        try {
            const timeObj = new Date(timeStr);
            const formattedTime = timeObj.toLocaleTimeString('zh-TW', {
                hour: '2-digit',
                minute: '2-digit'
            });
            labels.push(formattedTime);
            values.push(bytesVal);
        } catch (e) {
            continue;
        }
    }
    
    return { labels, values };
}

// å–å¾—å”è­°æ¨™èªŒæ¨£å¼é¡åˆ¥
function getProtocolBadgeClass(protocol) {
    const protocolColors = {
        'TCP': 'bg-primary',
        'UDP': 'bg-success', 
        'OTHER': 'bg-secondary',
        'UNKNOWN': 'bg-light text-dark'
    };
    return protocolColors[protocol] || 'bg-secondary';
}

// å–å¾—äº‹ä»¶åœ–ç¤º
function getEventIcon(eventType) {
    const icons = {
        'DNS': 'globe',
        'DHCP': 'network-wired',
        'SMTP': 'envelope',
        'TCP': 'exchange-alt',
        'TLS': 'lock',
        'SNMP': 'chart-line',
        'HTTP': 'globe',
        'HTTPS': 'lock',
        'FTP': 'file-alt',
        'SMB': 'folder',
        'SMB2': 'folder-open',
        'SMB3': 'folder-plus',
        'ICMP': 'satellite-dish',
        'OTHER': 'question-circle'
    };
    return icons[eventType] || 'question-circle';
}

// å–å¾—ç•°å¸¸åœ–ç¤º
function getAnomalyIcon(type) {
    const icons = {
        'high_traffic': 'tachometer-alt',
        'protocol_anomaly': 'exclamation-triangle',
        'geo_anomaly': 'globe-americas',
        'time_anomaly': 'clock',
        'suspicious_connection': 'eye'
    };
    return icons[type] || 'exclamation-circle';
}

// å–å¾—ç•°å¸¸æ¨™é¡Œ
function getAnomalyTitle(type) {
    const titles = {
        'high_traffic': 'å¤§æµé‡é€£æ¥è­¦ç¤º',
        'protocol_anomaly': 'å”è­°ç•°å¸¸è­¦ç¤º',
        'geo_anomaly': 'åœ°ç†ä½ç½®ç•°å¸¸',
        'time_anomaly': 'æ™‚é–“ç•°å¸¸è­¦ç¤º',
        'suspicious_connection': 'å¯ç–‘é€£æ¥'
    };
    return titles[type] || 'ç•°å¸¸è¡Œç‚ºåµæ¸¬';
}

// å–å¾—åš´é‡ç¨‹åº¦
function getSeverity(type) {
    // æ ¹æ“šç•°å¸¸é¡å‹è¿”å›åš´é‡ç¨‹åº¦
    const severityMap = {
        'high_traffic': 'high',
        'protocol_anomaly': 'medium',
        'geo_anomaly': 'medium',
        'time_anomaly': 'low',
        'suspicious_connection': 'high'
    };
    return severityMap[type] || 'medium';
}

// å–å¾—åš´é‡ç¨‹åº¦é¡è‰²
function getSeverityColor(type) {
    const severity = getSeverity(type);
    const colorMap = {
        'high': 'danger',
        'medium': 'warning',
        'low': 'info'
    };
    return colorMap[severity] || 'warning';
}

// é¡¯ç¤ºç•°å¸¸è©³æƒ…
function showAnomalyDetail(anomaly) {
    // å‰µå»ºæ¨¡æ…‹æ¡†å…§å®¹
    const modalHtml = `
        <div class="modal fade" id="anomalyDetailModal" tabindex="-1" aria-labelledby="anomalyDetailModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-${getSeverityColor(anomaly.type)}">
                        <h5 class="modal-title text-white" id="anomalyDetailModalLabel">
                            <i class="fas fa-${getAnomalyIcon(anomaly.type)} me-2"></i>
                            ${getAnomalyTitle(anomaly.type)}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>åš´é‡ç¨‹åº¦ï¼š</strong>
                                <span class="badge bg-${getSeverityColor(anomaly.type)} ms-2">
                                    ${getSeverity(anomaly.type).toUpperCase()}
                                </span>
                            </div>
                            <div class="col-md-6">
                                <strong>åµæ¸¬æ™‚é–“ï¼š</strong>
                                <span class="text-muted">${new Date(anomaly.time).toLocaleString()}</span>
                            </div>
                        </div>
                        
                        <div class="alert alert-${getSeverityColor(anomaly.type)} alert-dismissible">
                            <h6><i class="fas fa-info-circle me-2"></i>è©³ç´°èªªæ˜</h6>
                            <p class="mb-0">${anomaly.description}</p>
                        </div>
                        
                        ${anomaly.ip ? `
                        <div class="row mb-3">
                            <div class="col-12">
                                <strong>ç›¸é—œ IP åœ°å€ï¼š</strong>
                                <code class="ms-2">${anomaly.ip}</code>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${anomaly.connection ? `
                        <div class="row mb-3">
                            <div class="col-12">
                                <strong>é€£æ¥è³‡è¨Šï¼š</strong>
                                <code class="ms-2">${anomaly.connection}</code>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${anomaly.details ? `
                        <div class="row">
                            <div class="col-12">
                                <h6><i class="fas fa-list me-2"></i>æŠ€è¡“è©³æƒ…</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <tbody>
                                            ${Object.entries(anomaly.details).map(([key, value]) => `
                                                <tr>
                                                    <td><strong>${formatDetailKey(key)}</strong></td>
                                                    <td>${formatDetailValue(key, value)}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <h6><i class="fas fa-lightbulb me-2"></i>å»ºè­°è™•ç†æ–¹å¼</h6>
                                <div class="alert alert-info">
                                    ${getRecommendations(anomaly.type)}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                        <button type="button" class="btn btn-primary" onclick="copyAnomalyInfo('${JSON.stringify(anomaly).replace(/'/g, "\\'")}')">
                            <i class="fas fa-copy me-1"></i>è¤‡è£½è³‡è¨Š
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // ç§»é™¤ç¾æœ‰æ¨¡æ…‹æ¡†
    const existingModal = document.getElementById('anomalyDetailModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // æ·»åŠ æ–°æ¨¡æ…‹æ¡†
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // é¡¯ç¤ºæ¨¡æ…‹æ¡†
    const modal = new bootstrap.Modal(document.getElementById('anomalyDetailModal'));
    modal.show();
}

// æ ¼å¼åŒ–è©³æƒ…éµå
function formatDetailKey(key) {
    const keyMap = {
        'bytes': 'æµé‡å¤§å°',
        'rank': 'æ’å',
        'percentage': 'ç™¾åˆ†æ¯”',
        'protocol': 'å”è­°',
        'count': 'äº‹ä»¶æ•¸é‡',
        'country': 'åœ‹å®¶/åœ°å€',
        'time_period': 'æ™‚é–“å€é–“',
        'hour': 'å°æ™‚'
    };
    return keyMap[key] || key;
}

// æ ¼å¼åŒ–è©³æƒ…å€¼
function formatDetailValue(key, value) {
    if (key === 'bytes') {
        return formatBytes(value);
    } else if (key === 'percentage') {
        return `${value}%`;
    } else if (key === 'count') {
        return value.toLocaleString();
    }
    return value;
}

// å–å¾—å»ºè­°è™•ç†æ–¹å¼
function getRecommendations(type) {
    const recommendations = {
        'high_traffic': `
            <ol>
                <li>æª¢æŸ¥é€£æ¥çš„ç›®æ¨™ IP æ˜¯å¦ç‚ºå·²çŸ¥çš„åˆæ³•æœå‹™</li>
                <li>åˆ†ææµé‡å…§å®¹æ˜¯å¦åŒ…å«æ•æ„Ÿè³‡æ–™</li>
                <li>ç¢ºèªæ˜¯å¦ç‚ºé æœŸçš„å¤§æª”æ¡ˆå‚³è¼¸</li>
                <li>è€ƒæ…®å¯¦æ–½æµé‡é™åˆ¶æˆ–ç›£æ§</li>
            </ol>
        `,
        'protocol_anomaly': `
            <ol>
                <li>æ·±å…¥åˆ†æè©²å”è­°çš„ä½¿ç”¨æ¨¡å¼</li>
                <li>æª¢æŸ¥æ˜¯å¦æœ‰æœªé æœŸçš„æ‡‰ç”¨ç¨‹å¼åœ¨åŸ·è¡Œ</li>
                <li>ç¢ºèªå”è­°æµé‡çš„åˆæ³•æ€§</li>
                <li>è€ƒæ…®å¯¦æ–½å”è­°ç™½åå–®</li>
            </ol>
        `,
        'geo_anomaly': `
            <ol>
                <li>æª¢æŸ¥ä¾†æº IP çš„ä¿¡è­½åº¦</li>
                <li>ç¢ºèªæ˜¯å¦ç‚ºåˆæ³•çš„åœ‹éš›æ¥­å‹™éœ€æ±‚</li>
                <li>è€ƒæ…®å¯¦æ–½åœ°ç†ä½ç½®éæ¿¾</li>
                <li>åŠ å¼·å°è©²åœ°å€æµé‡çš„ç›£æ§</li>
            </ol>
        `,
        'time_anomaly': `
            <ol>
                <li>æª¢æŸ¥æ·±å¤œæ™‚æ®µçš„ç³»çµ±ä½¿ç”¨è€…</li>
                <li>ç¢ºèªæ˜¯å¦ç‚ºæ’ç¨‹çš„ç³»çµ±ç¶­è­·æˆ–å‚™ä»½</li>
                <li>åˆ†æç•°å¸¸æ™‚æ®µçš„æ´»å‹•é¡å‹</li>
                <li>è€ƒæ…®å¯¦æ–½æ™‚é–“åŸºç¤çš„å­˜å–æ§åˆ¶</li>
            </ol>
        `,
        'suspicious_connection': `
            <ol>
                <li>ç«‹å³éš”é›¢ç›¸é—œç³»çµ±é€²è¡Œè©³ç´°æª¢æŸ¥</li>
                <li>åˆ†æé€£æ¥çš„å…·é«”å…§å®¹å’Œç›®çš„</li>
                <li>æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–ç›¸ä¼¼çš„å¯ç–‘æ´»å‹•</li>
                <li>æ›´æ–°å®‰å…¨ç­–ç•¥å’Œç›£æ§è¦å‰‡</li>
            </ol>
        `
    };
    return recommendations[type] || 'è«‹è¯ç¹«è³‡å®‰åœ˜éšŠé€²è¡Œé€²ä¸€æ­¥åˆ†æã€‚';
}

// è¤‡è£½ç•°å¸¸è³‡è¨Š
function copyAnomalyInfo(anomalyJson) {
    try {
        const anomaly = JSON.parse(anomalyJson);
        const text = `
ç•°å¸¸é¡å‹ï¼š${getAnomalyTitle(anomaly.type)}
åš´é‡ç¨‹åº¦ï¼š${getSeverity(anomaly.type).toUpperCase()}
åµæ¸¬æ™‚é–“ï¼š${new Date(anomaly.time).toLocaleString()}
æè¿°ï¼š${anomaly.description}
${anomaly.ip ? `ç›¸é—œ IPï¼š${anomaly.ip}` : ''}
${anomaly.connection ? `é€£æ¥è³‡è¨Šï¼š${anomaly.connection}` : ''}
        `.trim();
        
        navigator.clipboard.writeText(text).then(() => {
            alert('ç•°å¸¸è³‡è¨Šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
        });
    } catch (e) {
        console.error('è¤‡è£½å¤±æ•—:', e);
    }
}

// é¡¯ç¤ºç‰¹å®šæ™‚é–“æ®µçš„æµé‡è©³æƒ…
async function showFlowDetails(timeKey) {
    try {
        const encodedTimeKey = encodeURIComponent(timeKey);
        const response = await fetch(`/api/flow_details/${taskName}/${encodedTimeKey}`);
        const data = await response.json();
        
        if (data.error) {
            alert('è¼‰å…¥æ™‚é–“æ®µè©³æƒ…å¤±æ•—: ' + data.error);
            return;
        }
        
        // é¡¯ç¤ºè©³æƒ…å€åŸŸ
        document.getElementById('flowDetailsSection').style.display = 'block';
        
        // æ›´æ–°æ¨™é¡Œ
        document.getElementById('selectedTimeLabel').textContent = `${data.time_period} è©³ç´°çµ±è¨ˆ`;
        
        // æ›´æ–°ç¸½æµé‡
        document.getElementById('selectedTimeTotalBytes').textContent = formatBytes(data.total_bytes);
        
        // æ›´æ–°é€£æ¥æ•¸é‡
        document.getElementById('selectedTimeConnectionCount').textContent = `${data.top_connections.length} å€‹`;
        
        // æ›´æ–°è¡¨æ ¼
        const tbody = document.getElementById('selectedTimeTopConnections');
        
        if (data.top_connections.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted">
                        <i class="fas fa-info-circle me-2"></i>
                        è©²æ™‚é–“æ®µæš«ç„¡è©³ç´°é€£æ¥çµ±è¨ˆ
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = data.top_connections.map((conn, index) => {
                const percentage = data.total_bytes > 0 ? ((conn.bytes / data.total_bytes) * 100).toFixed(1) : '0.0';
                const rankClass = index < 3 ? 'bg-warning' : 'bg-secondary';
                const rankIcon = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
                
                return `
                    <tr>
                        <td>
                            <span class="badge ${rankClass}">
                                ${rankIcon} ${index + 1}
                            </span>
                        </td>
                        <td>
                            <code class="text-break">${conn.connection}</code>
                        </td>
                        <td>
                            <span class="badge bg-info">${formatBytes(conn.bytes)}</span>
                        </td>
                        <td>
                            <span class="badge bg-success">${percentage}%</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // æ»¾å‹•åˆ°è©³æƒ…å€åŸŸ
        document.getElementById('flowDetailsSection').scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
        
    } catch (error) {
        console.error('è¼‰å…¥æµé‡è©³æƒ…å¤±æ•—:', error);
        alert('è¼‰å…¥æµé‡è©³æƒ…å¤±æ•—ï¼Œè«‹é‡è©¦');
    }
}

// éš±è—æµé‡è©³æƒ…
function hideFlowDetails() {
    document.getElementById('flowDetailsSection').style.display = 'none';
}

// é¡¯ç¤º Top IP é€£ç·šçš„é«˜æµé‡æ™‚é–“æ®µè©³æƒ…
function showTopIpDetails(connectionIndex) {
    if (!window.topIpData || !window.topIpData[connectionIndex]) {
        alert('ç„¡æ³•è¼‰å…¥é€£ç·šè©³ç´°è³‡è¨Š');
        return;
    }
    
    const connectionData = window.topIpData[connectionIndex];
    const timePeriods = connectionData.top_3_time_periods || [];
    const protocol = connectionData.protocol || 'UNKNOWN';
    
    // é¡¯ç¤ºè©³æƒ…å€åŸŸ
    document.getElementById('topIpDetailsSection').style.display = 'block';
    
    // æ›´æ–°é€£ç·šè³‡è¨Š
    document.getElementById('selectedConnectionLabel').textContent = `${connectionData.connection} - é«˜æµé‡æ™‚é–“æ®µåˆ†æ`;
    document.getElementById('selectedConnectionName').textContent = connectionData.connection;
    document.getElementById('selectedConnectionName').title = connectionData.connection;
    
    // é¡¯ç¤ºå”è­°è³‡è¨Š
    const protocolElement = document.getElementById('selectedConnectionProtocol');
    const protocolBadgeClass = getProtocolBadgeClass(protocol);
    protocolElement.innerHTML = `<span class="badge ${protocolBadgeClass}">${protocol}</span>`;
    
    document.getElementById('selectedConnectionTotalBytes').textContent = formatBytes(connectionData.bytes);
    document.getElementById('selectedConnectionPeriodCount').textContent = `${timePeriods.length} å€‹æ™‚æ®µ`;
    
    // æ›´æ–°æ™‚é–“æ®µè¡¨æ ¼
    const tbody = document.getElementById('selectedConnectionTimePeriods');
    
    if (timePeriods.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">
                    <i class="fas fa-info-circle me-2"></i>
                    è©²é€£ç·šæš«ç„¡è©³ç´°æ™‚é–“æ®µçµ±è¨ˆè³‡è¨Š
                </td>
            </tr>
        `;
    } else {
        tbody.innerHTML = timePeriods.map((period, index) => {
            const rankClass = index === 0 ? 'bg-warning' : index === 1 ? 'bg-info' : 'bg-secondary';
            const rankIcon = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰';
            
            // è¨ˆç®—æµé‡å¯†åº¦ (bytes per minute)
            const flowDensity = period.bytes / 10; // 10åˆ†é˜å€é–“
            
            return `
                <tr>
                    <td>
                        <span class="badge ${rankClass}">
                            ${rankIcon} ${period.rank}
                        </span>
                    </td>
                    <td>
                        <strong>${period.time_period}</strong>
                        <br>
                        <small class="text-muted">(10åˆ†é˜å€é–“)</small>
                    </td>
                    <td>
                        <span class="badge bg-primary">${formatBytes(period.bytes)}</span>
                    </td>
                    <td>
                        <span class="badge bg-success">${period.percentage_of_total}%</span>
                        <br>
                        <small class="text-muted">ä½”ç¸½æµé‡</small>
                    </td>
                    <td>
                        <span class="badge bg-info">${formatBytes(flowDensity)}/min</span>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    // æ»¾å‹•åˆ°è©³æƒ…å€åŸŸ
    document.getElementById('topIpDetailsSection').scrollIntoView({
        behavior: 'smooth',
        block: 'start'
    });
}

// éš±è— Top IP è©³æƒ…
function hideTopIpDetails() {
    document.getElementById('topIpDetailsSection').style.display = 'none';
}

// HTML è½‰ç¾©å‡½æ•¸
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
document.addEventListener('DOMContentLoaded', function() {
    loadAllData();
});
</script>
{% endblock %}
