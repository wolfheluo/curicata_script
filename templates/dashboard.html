{% extends "base.html" %}

{% block title %}{{ task_name }} - 分析結果{% endblock %}

{% block extra_css %}
<style>
.event-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.event-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.event-card:active {
    transform: translateY(-1px);
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-chart-bar me-2"></i>分析結果</h2>
                <p class="text-muted mb-0">任務：{{ task_name }}</p>
            </div>
            <div>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-1"></i>返回總覽
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 導航標籤 -->
<ul class="nav nav-tabs mb-4" id="analysisTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
            <i class="fas fa-tachometer-alt me-1"></i>總覽
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="flow-tab" data-bs-toggle="tab" data-bs-target="#flow" type="button" role="tab">
            <i class="fas fa-chart-line me-1"></i>流量趨勢
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="topip-tab" data-bs-toggle="tab" data-bs-target="#topip" type="button" role="tab">
            <i class="fas fa-list-ol me-1"></i>Top IP
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="geo-tab" data-bs-toggle="tab" data-bs-target="#geo" type="button" role="tab">
            <i class="fas fa-globe me-1"></i>國別統計
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="events-tab" data-bs-toggle="tab" data-bs-target="#events" type="button" role="tab">
            <i class="fas fa-exclamation-triangle me-1"></i>事件分析
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="anomaly-tab" data-bs-toggle="tab" data-bs-target="#anomaly" type="button" role="tab">
            <i class="fas fa-shield-alt me-1"></i>異常警示
        </button>
    </li>
</ul>

<!-- 標籤內容 -->
<div class="tab-content" id="analysisTabContent">
    <!-- 總覽 -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
        <div class="row" id="overview-cards">
            <!-- 統計卡片將由 JavaScript 動態載入 -->
        </div>
    </div>

    <!-- 流量趨勢 -->
    <div class="tab-pane fade" id="flow" role="tabpanel">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>每10分鐘流量統計</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="flowChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top IP -->
    <div class="tab-pane fade" id="topip" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar me-2"></i>流量排行圖</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="topIpChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list me-2"></i>詳細清單</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="topIpTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>連線</th>
                                        <th>流量</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 資料將由 JavaScript 動態載入 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 國別統計 -->
    <div class="tab-pane fade" id="geo" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie me-2"></i>國別分布圓餅圖</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="geoChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-flag me-2"></i>國別排名</h5>
                    </div>
                    <div class="card-body">
                        <div id="geoList">
                            <!-- 國別清單將由 JavaScript 動態載入 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 事件分析 -->
    <div class="tab-pane fade" id="events" role="tabpanel">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>網路事件統計</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="eventStats">
                            <!-- 事件統計將由 JavaScript 動態載入 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 異常警示 -->
    <div class="tab-pane fade" id="anomaly" role="tabpanel">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-shield-alt me-2"></i>異常行為偵測</h5>
                        <span class="badge bg-danger" id="anomalyCount">0</span>
                    </div>
                    <div class="card-body">
                        <div id="anomalyList">
                            <!-- 異常清單將由 JavaScript 動態載入 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- 載入指示器 -->
<div id="loadingIndicator" class="text-center py-5" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">載入中...</span>
    </div>
    <p class="mt-2 text-muted">載入分析資料中...</p>
</div>

<!-- 事件詳細統計模態框 -->
<div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-labelledby="eventDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventDetailsModalLabel">協議詳細統計</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="eventDetailsContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">載入中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const taskName = '{{ task_name }}';
let charts = {};

// 載入所有分析資料
async function loadAllData() {
    document.getElementById('loadingIndicator').style.display = 'block';
    
    try {
        await Promise.all([
            loadOverview(),
            loadFlowData(),
            loadTopIpData(),
            loadGeoData(),
            loadEventData(),
            loadAnomalyData()
        ]);
    } catch (error) {
        console.error('載入資料失敗:', error);
        alert('載入分析資料失敗，請重新整理頁面');
    } finally {
        document.getElementById('loadingIndicator').style.display = 'none';
    }
}

// 載入總覽資料
async function loadOverview() {
    const [flowResponse, eventsResponse, anomalyResponse] = await Promise.all([
        fetch(`/api/flow/${taskName}`),
        fetch(`/api/events/${taskName}`),
        fetch(`/api/anomaly/${taskName}`)
    ]);
    
    const flowData = await flowResponse.json();
    const eventsData = await eventsResponse.json();
    const anomalyData = await anomalyResponse.json();
    
    const totalEvents = Object.values(eventsData).reduce((sum, event) => sum + (event.count || 0), 0);
    
    const overviewCards = document.getElementById('overview-cards');
    overviewCards.innerHTML = `
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <i class="fas fa-database fa-3x text-primary mb-3"></i>
                    <h4>${formatBytes(flowData.total_bytes || 0)}</h4>
                    <p class="text-muted mb-0">總流量</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <i class="fas fa-clock fa-3x text-info mb-3"></i>
                    <h4>${calculateDuration(flowData.start_time, flowData.end_time)}</h4>
                    <p class="text-muted mb-0">分析時長</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h4>${totalEvents.toLocaleString()}</h4>
                    <p class="text-muted mb-0">網路事件</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <i class="fas fa-shield-alt fa-3x text-danger mb-3"></i>
                    <h4>${anomalyData.length}</h4>
                    <p class="text-muted mb-0">異常警示</p>
                </div>
            </div>
        </div>
    `;
}

// 載入流量資料
async function loadFlowData() {
    const response = await fetch(`/api/flow/${taskName}`);
    const data = await response.json();
    
    const ctx = document.getElementById('flowChart').getContext('2d');
    
    if (charts.flow) {
        charts.flow.destroy();
    }
    
    // 使用每10分鐘統計，如果不存在則從每分鐘資料生成
    let flowData = data.per_10_minutes || {};
    
    if (Object.keys(flowData).length === 0 && data.per_minute) {
        // 從每分鐘資料生成每10分鐘統計
        flowData = generateTenMinuteStats(data.per_minute, data.start_time, data.end_time);
    }
    
    // 如果仍然沒有資料，則使用每小時統計
    if (Object.keys(flowData).length === 0 && data.per_hour) {
        flowData = data.per_hour;
    }
    
    // 生成排序後的時間標籤和對應的數據值
    const sortedFlowData = getSortedFlowData(flowData, data.start_time, data.end_time);
    
    charts.flow = new Chart(ctx, {
        type: 'line',
        data: {
            labels: sortedFlowData.labels,
            datasets: [{
                label: '流量 (Bytes)',
                data: sortedFlowData.values,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatBytes(value);
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '流量: ' + formatBytes(context.parsed.y);
                        }
                    }
                }
            }
        }
    });
}

// 載入 Top IP 資料
async function loadTopIpData() {
    const response = await fetch(`/api/top_ip/${taskName}`);
    const data = await response.json();
    
    // 圖表
    const ctx = document.getElementById('topIpChart').getContext('2d');
    
    if (charts.topIp) {
        charts.topIp.destroy();
    }
    
    const top10 = data.slice(0, 10);
    
    charts.topIp = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: top10.map(item => item.connection.substring(0, 20) + '...'),
            datasets: [{
                label: '流量 (Bytes)',
                data: top10.map(item => item.bytes),
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatBytes(value);
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return top10[context[0].dataIndex].connection;
                        },
                        label: function(context) {
                            return '流量: ' + formatBytes(context.parsed.y);
                        }
                    }
                }
            }
        }
    });
    
    // 表格
    const tableBody = document.querySelector('#topIpTable tbody');
    tableBody.innerHTML = data.slice(0, 20).map((item, index) => `
        <tr>
            <td>${index + 1}</td>
            <td><code>${item.connection}</code></td>
            <td>${formatBytes(item.bytes)}</td>
        </tr>
    `).join('');
}

// 載入國別資料
async function loadGeoData() {
    const response = await fetch(`/api/geo/${taskName}`);
    const data = await response.json();
    
    // 將資料轉換為陣列並按計數排序（由多到少）
    const sortedCountries = Object.entries(data)
        .sort((a, b) => b[1] - a[1]);
    
    const countries = sortedCountries.map(([country, count]) => country);
    const counts = sortedCountries.map(([country, count]) => count);
    
    // 圓餅圖
    const ctx = document.getElementById('geoChart').getContext('2d');
    
    if (charts.geo) {
        charts.geo.destroy();
    }
    
    charts.geo = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: countries,
            datasets: [{
                data: counts,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                    '#4BC0C0', '#FF6384'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // 國別清單
    const geoList = document.getElementById('geoList');
    const total = counts.reduce((sum, count) => sum + count, 0);
    
    geoList.innerHTML = sortedCountries.map(([country, count], index) => {
        const percentage = ((count / total) * 100).toFixed(1);
        return `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span><span class="badge bg-secondary me-2">${index + 1}</span><strong>${country}</strong></span>
                <div>
                    <span class="badge bg-primary me-2">${count}</span>
                    <span class="text-muted">${percentage}%</span>
                </div>
            </div>
        `;
    }).join('');
}

// 載入事件資料
async function loadEventData() {
    const response = await fetch(`/api/events/${taskName}`);
    const data = await response.json();
    
    const eventStats = document.getElementById('eventStats');
    eventStats.innerHTML = Object.entries(data).map(([eventType, eventData]) => `
        <div class="col-md-4 col-lg-2 mb-3">
            <div class="card text-center event-card" style="cursor: pointer;" onclick="showEventDetails('${eventType}')">
                <div class="card-body">
                    <i class="fas fa-${getEventIcon(eventType)} fa-2x text-primary mb-2"></i>
                    <h5>${eventData.count || 0}</h5>
                    <p class="card-text">${eventType}</p>
                    <small class="text-muted">主要來源: ${eventData.top_ip || 'N/A'}</small>
                    <div class="mt-2">
                        <small class="badge bg-info">點擊查看詳情</small>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// 載入異常資料
async function loadAnomalyData() {
    const response = await fetch(`/api/anomaly/${taskName}`);
    const data = await response.json();
    
    document.getElementById('anomalyCount').textContent = data.length;
    
    const anomalyList = document.getElementById('anomalyList');
    
    if (data.length === 0) {
        anomalyList.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h5 class="text-success">未發現異常行為</h5>
                <p class="text-muted">所有分析的網路流量都在正常範圍內</p>
            </div>
        `;
    } else {
        // 按異常類型分組
        const groupedData = data.reduce((groups, anomaly) => {
            const type = anomaly.type;
            if (!groups[type]) {
                groups[type] = [];
            }
            groups[type].push(anomaly);
            return groups;
        }, {});

        // 生成分組後的 HTML
        const groupsHtml = Object.entries(groupedData).map(([type, anomalies], index) => {
            const collapseId = `anomaly-collapse-${index}`;
            const severity = getSeverity(type);
            const severityColor = getSeverityColor(type);
            
            return `
                <div class="card mb-3 border-${severityColor}">
                    <div class="card-header bg-${severityColor} bg-opacity-10 border-${severityColor}">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <button class="btn btn-link text-decoration-none p-0 text-${severityColor} fw-bold" 
                                        type="button" 
                                        data-bs-toggle="collapse" 
                                        data-bs-target="#${collapseId}"
                                        aria-expanded="false" 
                                        aria-controls="${collapseId}">
                                    <i class="fas fa-${getAnomalyIcon(type)} me-2"></i>
                                    ${getAnomalyTitle(type)}
                                    <i class="fas fa-chevron-down ms-2 collapse-icon"></i>
                                </button>
                            </h6>
                            <div>
                                <span class="badge bg-${severityColor} me-2">${severity.toUpperCase()}</span>
                                <span class="badge bg-secondary">${anomalies.length} 項</span>
                            </div>
                        </div>
                    </div>
                    <div class="collapse" id="${collapseId}">
                        <div class="card-body">
                            ${anomalies.map((anomaly, anomalyIndex) => `
                                <div class="alert alert-${severityColor} alert-dismissible mb-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <p class="mb-2">${anomaly.description || '偵測到可疑行為'}</p>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <small class="text-muted">
                                                        <i class="fas fa-map-marker-alt me-1"></i>
                                                        <strong>來源 IP:</strong> ${anomaly.ip}
                                                    </small>
                                                </div>
                                                <div class="col-md-6">
                                                    <small class="text-muted">
                                                        <i class="fas fa-clock me-1"></i>
                                                        <strong>時間:</strong> ${new Date(anomaly.time).toLocaleString()}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="ms-3">
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-${severityColor} anomaly-detail-btn" 
                                                    onclick="showAnomalyDetail(${JSON.stringify(anomaly).replace(/"/g, '&quot;')})"
                                                    title="查看詳情">
                                                <i class="fas fa-eye me-1"></i>詳情
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        anomalyList.innerHTML = groupsHtml;

        // 為摺疊按鈕添加圖示切換效果
        document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
            button.addEventListener('click', function() {
                const icon = this.querySelector('.collapse-icon');
                const target = document.querySelector(this.getAttribute('data-bs-target'));
                
                target.addEventListener('shown.bs.collapse', function () {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                });
                
                target.addEventListener('hidden.bs.collapse', function () {
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                });
            });
        });
    }
}

// 工具函數
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}


function calculateDuration(startTime, endTime) {
    if (!startTime || !endTime) return 'N/A';
    const start = new Date(startTime);
    const end = new Date(endTime);
    const diffMs = end - start;
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
    return `${diffHours}h ${diffMinutes}m`;
}

function getEventIcon(eventType) {
    const icons = {
    };
    return icons[eventType] || 'question';
}

function getAnomalyIcon(type) {
    const icons = {
    };
    return icons[type] || 'exclamation-circle';
}

// 顯示事件詳細統計
async function showEventDetails(protocol) {
    const modal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
    const modalTitle = document.getElementById('eventDetailsModalLabel');
    const modalContent = document.getElementById('eventDetailsContent');
    
    modalTitle.textContent = `${protocol} 協議詳細統計`;
    modalContent.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">載入中...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    try {
        const response = await fetch(`/api/event_details/${taskName}/${protocol}`);
        const data = await response.json();
        
        if (data.error) {
            modalContent.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${data.error}
                </div>
            `;
            return;
        }
        
        const topConnections = data.top_connections || [];
        
        modalContent.innerHTML = `
            <div class="mb-3">
                <h6><i class="fas fa-info-circle me-2"></i>總覽</h6>
                <p class="mb-1"><strong>協議：</strong>${data.protocol}</p>
                <p class="mb-1"><strong>總封包數：</strong>${data.total_count?.toLocaleString() || 0}</p>
            </div>
            
            <h6><i class="fas fa-trophy me-2"></i>前5名連接統計</h6>
            ${topConnections.length === 0 ? 
                '<div class="alert alert-info">尚無詳細統計資料</div>' :
                `<div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>來源 IP</th>
                                <th>目標 IP</th>
                                <th>封包數</th>
                                <th>封包大小 (Bytes)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${topConnections.map((conn, index) => `
                                <tr>
                                    <td>
                                        <span class="badge ${index < 3 ? 'bg-warning' : 'bg-secondary'}">
                                            ${index + 1}
                                        </span>
                                    </td>
                                    <td>
                                        <code>${conn.src_ip}</code>
                                    </td>
                                    <td>
                                        <code>${conn.dst_ip}</code>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">${conn.packet_count?.toLocaleString() || 0}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">${formatBytes(conn.packet_size || 0)}</span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`
            }
        `;
        
    } catch (error) {
        modalContent.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                載入失敗：${error.message}
            </div>
        `;
    }
}

// 格式化字節大小
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// 從每分鐘資料生成每10分鐘統計
function generateTenMinuteStats(perMinuteData, startTime, endTime) {
    const result = {};
    
    for (const [timeStr, bytesVal] of Object.entries(perMinuteData)) {
        try {
            const timeObj = new Date(timeStr);
            const minuteBoundary = Math.floor(timeObj.getMinutes() / 10) * 10;
            const boundaryTime = new Date(timeObj);
            boundaryTime.setMinutes(minuteBoundary, 0, 0);
            
            const boundaryStr = boundaryTime.toISOString().slice(0, 16).replace('T', ' ');
            
            if (!result[boundaryStr]) {
                result[boundaryStr] = 0;
            }
            result[boundaryStr] += bytesVal;
        } catch (e) {
            continue;
        }
    }
    
    return result;
}

// 生成排序後的流量資料
function getSortedFlowData(flowData, startTime, endTime) {
    const sortedItems = Object.entries(flowData).sort();
    const labels = [];
    const values = [];
    
    for (const [timeStr, bytesVal] of sortedItems) {
        try {
            const timeObj = new Date(timeStr);
            const formattedTime = timeObj.toLocaleTimeString('zh-TW', {
                hour: '2-digit',
                minute: '2-digit'
            });
            labels.push(formattedTime);
            values.push(bytesVal);
        } catch (e) {
            continue;
        }
    }
    
    return { labels, values };
}

// 取得事件圖示
function getEventIcon(eventType) {
    const icons = {
        'DNS': 'globe',
        'DHCP': 'network-wired',
        'SMTP': 'envelope',
        'TCP': 'exchange-alt',
        'TLS': 'lock',
        'SNMP': 'chart-line',
        'HTTP': 'globe',
        'HTTPS': 'lock',
        'FTP': 'file-alt',
        'SMB': 'folder',
        'SMB2': 'folder-open',
        'SMB3': 'folder-plus',
        'ICMP': 'satellite-dish',
        'OTHER': 'question-circle'
    };
    return icons[eventType] || 'question-circle';
}

// 取得異常圖示
function getAnomalyIcon(type) {
    const icons = {
        'high_traffic': 'tachometer-alt',
        'protocol_anomaly': 'exclamation-triangle',
        'geo_anomaly': 'globe-americas',
        'time_anomaly': 'clock',
        'suspicious_connection': 'eye'
    };
    return icons[type] || 'exclamation-circle';
}

// 取得異常標題
function getAnomalyTitle(type) {
    const titles = {
        'high_traffic': '大流量連接警示',
        'protocol_anomaly': '協議異常警示',
        'geo_anomaly': '地理位置異常',
        'time_anomaly': '時間異常警示',
        'suspicious_connection': '可疑連接'
    };
    return titles[type] || '異常行為偵測';
}

// 取得嚴重程度
function getSeverity(type) {
    // 根據異常類型返回嚴重程度
    const severityMap = {
        'high_traffic': 'high',
        'protocol_anomaly': 'medium',
        'geo_anomaly': 'medium',
        'time_anomaly': 'low',
        'suspicious_connection': 'high'
    };
    return severityMap[type] || 'medium';
}

// 取得嚴重程度顏色
function getSeverityColor(type) {
    const severity = getSeverity(type);
    const colorMap = {
        'high': 'danger',
        'medium': 'warning',
        'low': 'info'
    };
    return colorMap[severity] || 'warning';
}

// 顯示異常詳情
function showAnomalyDetail(anomaly) {
    // 創建模態框內容
    const modalHtml = `
        <div class="modal fade" id="anomalyDetailModal" tabindex="-1" aria-labelledby="anomalyDetailModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-${getSeverityColor(anomaly.type)}">
                        <h5 class="modal-title text-white" id="anomalyDetailModalLabel">
                            <i class="fas fa-${getAnomalyIcon(anomaly.type)} me-2"></i>
                            ${getAnomalyTitle(anomaly.type)}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>嚴重程度：</strong>
                                <span class="badge bg-${getSeverityColor(anomaly.type)} ms-2">
                                    ${getSeverity(anomaly.type).toUpperCase()}
                                </span>
                            </div>
                            <div class="col-md-6">
                                <strong>偵測時間：</strong>
                                <span class="text-muted">${new Date(anomaly.time).toLocaleString()}</span>
                            </div>
                        </div>
                        
                        <div class="alert alert-${getSeverityColor(anomaly.type)} alert-dismissible">
                            <h6><i class="fas fa-info-circle me-2"></i>詳細說明</h6>
                            <p class="mb-0">${anomaly.description}</p>
                        </div>
                        
                        ${anomaly.ip ? `
                        <div class="row mb-3">
                            <div class="col-12">
                                <strong>相關 IP 地址：</strong>
                                <code class="ms-2">${anomaly.ip}</code>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${anomaly.connection ? `
                        <div class="row mb-3">
                            <div class="col-12">
                                <strong>連接資訊：</strong>
                                <code class="ms-2">${anomaly.connection}</code>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${anomaly.details ? `
                        <div class="row">
                            <div class="col-12">
                                <h6><i class="fas fa-list me-2"></i>技術詳情</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <tbody>
                                            ${Object.entries(anomaly.details).map(([key, value]) => `
                                                <tr>
                                                    <td><strong>${formatDetailKey(key)}</strong></td>
                                                    <td>${formatDetailValue(key, value)}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <h6><i class="fas fa-lightbulb me-2"></i>建議處理方式</h6>
                                <div class="alert alert-info">
                                    ${getRecommendations(anomaly.type)}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                        <button type="button" class="btn btn-primary" onclick="copyAnomalyInfo('${JSON.stringify(anomaly).replace(/'/g, "\\'")}')">
                            <i class="fas fa-copy me-1"></i>複製資訊
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 移除現有模態框
    const existingModal = document.getElementById('anomalyDetailModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // 添加新模態框
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // 顯示模態框
    const modal = new bootstrap.Modal(document.getElementById('anomalyDetailModal'));
    modal.show();
}

// 格式化詳情鍵名
function formatDetailKey(key) {
    const keyMap = {
        'bytes': '流量大小',
        'rank': '排名',
        'percentage': '百分比',
        'protocol': '協議',
        'count': '事件數量',
        'country': '國家/地區',
        'time_period': '時間區間',
        'hour': '小時'
    };
    return keyMap[key] || key;
}

// 格式化詳情值
function formatDetailValue(key, value) {
    if (key === 'bytes') {
        return formatBytes(value);
    } else if (key === 'percentage') {
        return `${value}%`;
    } else if (key === 'count') {
        return value.toLocaleString();
    }
    return value;
}

// 取得建議處理方式
function getRecommendations(type) {
    const recommendations = {
        'high_traffic': `
            <ol>
                <li>檢查連接的目標 IP 是否為已知的合法服務</li>
                <li>分析流量內容是否包含敏感資料</li>
                <li>確認是否為預期的大檔案傳輸</li>
                <li>考慮實施流量限制或監控</li>
            </ol>
        `,
        'protocol_anomaly': `
            <ol>
                <li>深入分析該協議的使用模式</li>
                <li>檢查是否有未預期的應用程式在執行</li>
                <li>確認協議流量的合法性</li>
                <li>考慮實施協議白名單</li>
            </ol>
        `,
        'geo_anomaly': `
            <ol>
                <li>檢查來源 IP 的信譽度</li>
                <li>確認是否為合法的國際業務需求</li>
                <li>考慮實施地理位置過濾</li>
                <li>加強對該地區流量的監控</li>
            </ol>
        `,
        'time_anomaly': `
            <ol>
                <li>檢查深夜時段的系統使用者</li>
                <li>確認是否為排程的系統維護或備份</li>
                <li>分析異常時段的活動類型</li>
                <li>考慮實施時間基礎的存取控制</li>
            </ol>
        `,
        'suspicious_connection': `
            <ol>
                <li>立即隔離相關系統進行詳細檢查</li>
                <li>分析連接的具體內容和目的</li>
                <li>檢查是否有其他相似的可疑活動</li>
                <li>更新安全策略和監控規則</li>
            </ol>
        `
    };
    return recommendations[type] || '請聯繫資安團隊進行進一步分析。';
}

// 複製異常資訊
function copyAnomalyInfo(anomalyJson) {
    try {
        const anomaly = JSON.parse(anomalyJson);
        const text = `
異常類型：${getAnomalyTitle(anomaly.type)}
嚴重程度：${getSeverity(anomaly.type).toUpperCase()}
偵測時間：${new Date(anomaly.time).toLocaleString()}
描述：${anomaly.description}
${anomaly.ip ? `相關 IP：${anomaly.ip}` : ''}
${anomaly.connection ? `連接資訊：${anomaly.connection}` : ''}
        `.trim();
        
        navigator.clipboard.writeText(text).then(() => {
            alert('異常資訊已複製到剪貼簿');
        });
    } catch (e) {
        console.error('複製失敗:', e);
    }
}

// HTML 轉義函數
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// 頁面載入完成後執行
document.addEventListener('DOMContentLoaded', function() {
    loadAllData();
});
</script>
{% endblock %}
